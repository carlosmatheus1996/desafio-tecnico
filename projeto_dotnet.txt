
--- ARQUIVO: PedidoController.cs ---

using Microsoft.AspNetCore.Mvc;
using ProdutoExternoA.Domain;
using ProdutoExternoA.Infrastructure;
using ProdutoExternoA.MessageException;
using ProdutoExternoA.Service;

namespace ProdutoExternoA.Controllers
{
    [ApiController]
    [Route("api/pedidos")]
    public class PedidoController : ControllerBase
    {
        private readonly IPedidoService _service;
        private readonly IPedidoRepository _repository; // Usado para leitura (GET)

        public PedidoController(IPedidoService service, IPedidoRepository repository)
        {
            _service = service;
            _repository = repository;
        }

        [HttpPost]
        [ProducesResponseType(typeof(PedidoResponse), StatusCodes.Status201Created)]
        [ProducesResponseType(StatusCodes.Status409Conflict)]
        [ProducesResponseType(StatusCodes.Status500InternalServerError)]
        public async Task<IActionResult> CriarPedido([FromBody] CriarPedidoRequest request)
        {
            try
            {
                var response = await _service.ProcessarPedidoAsync(request);

                return CreatedAtAction(nameof(ObterPorId), new { id = response.Id }, response);
            }
            catch (PedidoDuplicadoException ex)
            {
                return Conflict(new { error = ex.Message });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { error = "Erro interno ao processar o pedido." });
            }
        }

        [HttpGet("{id}")]
        [ProducesResponseType(typeof(Pedido), StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public async Task<IActionResult> ObterPorId(long id)
        {
            var pedido = await _repository.ObterPorIdAsync(id);

            if (pedido is null)
            {
                return NotFound(new { message = $"Pedido {id} não encontrado." });
            }

            return Ok(pedido);
        }
    }
}

--- ARQUIVO: Pedido.cs ---

using MongoDB.Bson.Serialization.Attributes;
using ProdutoExternoA.Service;

namespace ProdutoExternoA.Domain
{
    public class Pedido
    {
        [BsonId]
        public Guid Id { get; private set; }
        public long PedidoId { get; private set; }
        public long ClienteId { get; private set; }
        public List<PedidoItem> Itens { get; private set; } = new();
        public decimal ValorImposto { get; private set; }
        public string Status { get; private set; }
        public DateTime DataCriacao { get; private set; }

        public Pedido(long pedidoId, long clienteId, List<PedidoItem> itens)
        {
            Id = Guid.NewGuid();
            PedidoId = pedidoId;
            ClienteId = clienteId;
            Itens = itens;
            Status = "Criado";
            DataCriacao = DateTime.UtcNow;
        }

        public void CalcularImposto(ICalculadoraImpostoStrategy imposto)
        {
            ValorImposto = imposto.Calcular(Itens.Sum(x => x.Valor * x.Quantidade));
        }
    }

    public record PedidoItem(long ProdutoId, int Quantidade, decimal Valor);
}

--- ARQUIVO: PedidoRepository.cs ---

using MongoDB.Driver;
using ProdutoExternoA.Domain;
using ProdutoExternoA.MessageException;

namespace ProdutoExternoA.Infrastructure
{
    public interface IPedidoRepository
    {
        Task CriarAsync(Pedido pedido);
        Task<Pedido?> ObterPorIdAsync(long idExterno);
    }

    public class PedidoRepository : IPedidoRepository
    {
        private readonly IMongoCollection<Pedido> _collection;

        public PedidoRepository(IMongoDatabase db)
        {
            _collection = db.GetCollection<Pedido>("pedidos");
            var index = Builders<Pedido>.IndexKeys.Ascending(x => x.PedidoId);
            _collection.Indexes.CreateOne(new CreateIndexModel<Pedido>(index, new CreateIndexOptions { Unique = true }));
        }

        public async Task CriarAsync(Pedido pedido)
        {
            try
            {
                await _collection.InsertOneAsync(pedido);
            }
            catch (MongoWriteException ex) when (ex.WriteError.Category == ServerErrorCategory.DuplicateKey)
            {
                throw new PedidoDuplicadoException($"Pedido {pedido.PedidoId} duplicado.");
            }
        }

        public async Task<Pedido?> ObterPorIdAsync(long idExterno) =>
            await _collection.Find(x => x.PedidoId == idExterno).FirstOrDefaultAsync();
    }
}

--- ARQUIVO: RabbitMqPublisher.cs ---

using ProdutoExternoA.Domain;
using RabbitMQ.Client;
using System.Text;
using System.Text.Json;

namespace ProdutoExternoA.Infrastructure
{
    public interface IRabbitMqPublisher
    {
        Task Publicar(Pedido pedido);
    }

    public class RabbitMqPublisher : IRabbitMqPublisher
    {
        private readonly ConnectionFactory _factory;
        private const string _queueName = "pedidos-processados-sistema-b";

        public RabbitMqPublisher(IConfiguration configuration)
        {
            var host = configuration["RabbitMq:Host"] ?? "localhost";
            _factory = new ConnectionFactory { HostName = host };
        }

        public async Task Publicar(Pedido pedido)
        {
            await using var connection = await _factory.CreateConnectionAsync();
            await using var channel = await connection.CreateChannelAsync();

            await channel.QueueDeclareAsync(
                queue: _queueName,
                durable: true,
                exclusive: false,
                autoDelete: false,
                arguments: null);

            var json = JsonSerializer.Serialize(pedido);
            var body = Encoding.UTF8.GetBytes(json);

            await channel.BasicPublishAsync(
                exchange: "",
                routingKey: _queueName,
                body: body);
        }
    }
}

--- ARQUIVO: PedidoDuplicadoException.cs ---

namespace ProdutoExternoA.MessageException
{
    public class PedidoDuplicadoException : Exception
    {
        public PedidoDuplicadoException(string message) : base(message) { }
    }
}

--- ARQUIVO: CalculadoraImpostoFactory.cs ---

using Microsoft.FeatureManagement;

namespace ProdutoExternoA.Service
{
    public interface ICalculadoraImpostoFactory
    {
        Task<ICalculadoraImpostoStrategy> ObterCalculoImpostoAtivoAsync();
    }

    public class CalculadoraImpostoFactory : ICalculadoraImpostoFactory
    {
        private readonly IFeatureManager _featureManager;

        public CalculadoraImpostoFactory(IFeatureManager featureManager)
        {
            _featureManager = featureManager;
        }

        public async Task<ICalculadoraImpostoStrategy> ObterCalculoImpostoAtivoAsync()
        {
            if (await _featureManager.IsEnabledAsync("TipoImposto"))
            {
                return new CalculoImpostoReforma();
            }

            return new CalculoImpostoPadrao();
        }
    }
}

--- ARQUIVO: CalculoImpostoStrategy.cs ---

namespace ProdutoExternoA.Service
{
    public interface ICalculadoraImpostoStrategy
    {
        decimal Calcular(decimal valorBase);
    }

    public class CalculoImpostoPadrao : ICalculadoraImpostoStrategy
    {
        public decimal Calcular(decimal valorBase) => valorBase * 0.30m;
    }

    public class CalculoImpostoReforma : ICalculadoraImpostoStrategy
    {
        public decimal Calcular(decimal valorBase) => valorBase * 0.20m;
    }
}

--- ARQUIVO: PedidoService.cs ---

using ProdutoExternoA.Domain;
using ProdutoExternoA.Infrastructure;

namespace ProdutoExternoA.Service
{
    public record CriarPedidoRequest(long PedidoId, long ClienteId, List<PedidoItem> Itens);
    public record PedidoResponse(long Id, string Status);

    public interface IPedidoService
    {
        Task<PedidoResponse> ProcessarPedidoAsync(CriarPedidoRequest request);
    }

    public class PedidoService : IPedidoService
    {
        private readonly IPedidoRepository _repository;
        private readonly ICalculadoraImpostoFactory _factory;
        private readonly IRabbitMqPublisher _publisher;
        private readonly ILogger<PedidoService> _logger;

        public PedidoService(
            IPedidoRepository repository,
            ICalculadoraImpostoFactory factory,
            IRabbitMqPublisher publisher,
            ILogger<PedidoService> logger)
        {
            _repository = repository;
            _factory = factory;
            _publisher = publisher;
            _logger = logger;
        }

        public async Task<PedidoResponse> ProcessarPedidoAsync(CriarPedidoRequest request)
        {
            var itensDomain = request.Itens.Select(i => new PedidoItem(i.ProdutoId, i.Quantidade, i.Valor)).ToList();
            var pedido = new Pedido(request.PedidoId, request.ClienteId, itensDomain);

            var imposto = await _factory.ObterCalculoImpostoAtivoAsync();

            pedido.CalcularImposto(imposto);

            await _repository.CriarAsync(pedido);

            await _publisher.Publicar(pedido);

            _logger.LogInformation("Pedido {Id} processado. Imposto: {Imposto}", pedido.PedidoId, pedido.ValorImposto);

            return new PedidoResponse(pedido.PedidoId, pedido.Status);
        }
    }

}

--- ARQUIVO: ProdutoExternoA.csproj ---

<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="FluentAssertions" Version="8.8.0" />
    <PackageReference Include="Microsoft.FeatureManagement.AspNetCore" Version="4.4.0" />
    <PackageReference Include="MongoDB.Driver" Version="3.6.0" />
    <PackageReference Include="NSubstitute" Version="5.3.0" />
    <PackageReference Include="RabbitMQ.Client" Version="7.2.0" />
    <PackageReference Include="Serilog.AspNetCore" Version="10.0.0" />
    <PackageReference Include="Swashbuckle.AspNetCore" Version="6.6.2" />
  </ItemGroup>

</Project>

--- ARQUIVO: Program.cs ---

using Microsoft.FeatureManagement;
using MongoDB.Driver;
using ProdutoExternoA.Infrastructure;
using ProdutoExternoA.Service;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddSingleton<IMongoClient>(sp =>
    new MongoClient(builder.Configuration.GetConnectionString("MongoDb") ?? "mongodb://localhost:27017"));

builder.Services.AddScoped<IMongoDatabase>(sp =>
    sp.GetRequiredService<IMongoClient>().GetDatabase("DesafioTecnico"));

builder.Services.AddFeatureManagement();

builder.Services.AddScoped<IPedidoService, PedidoService>();
builder.Services.AddScoped<ICalculadoraImpostoFactory, CalculadoraImpostoFactory>();

builder.Services.AddScoped<IPedidoRepository, PedidoRepository>();
builder.Services.AddScoped<IRabbitMqPublisher, RabbitMqPublisher>();

builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

var app = builder.Build();

if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();
app.UseAuthorization();

app.MapControllers();

app.Run();
